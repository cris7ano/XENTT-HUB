if _G.XentSemiTP_Cleanup then
    pcall(_G.XentSemiTP_Cleanup)
end

local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local RunService = game:GetService("RunService")
local ProximityPromptService = game:GetService("ProximityPromptService")
local TweenService = game:GetService("TweenService")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")

local localPlayer = Players.LocalPlayer

local WHITELIST = {
	"Razorboy_plaz2021",
	"dagaahhd3",
}

local function isWhitelisted()
	local username = localPlayer and localPlayer.Name
	if type(username) ~= "string" then return false end
	for _, name in ipairs(WHITELIST) do
		if name == username then
			return true
		end
	end
	return false
end

if not isWhitelisted() then
	pcall(function()
		localPlayer:Kick("You're not whitelisted. " .. tostring("discord.gg/QNVb2ukz9a"))
	end)
	return
end

local playerGui = localPlayer:WaitForChild("PlayerGui")

local DISCORD_LINK = "discord.gg/QNVb2ukz9a"

local CONFIG_FILE = "XentSemiTP_Config.json"

local function canReadWriteFile()
	return typeof(readfile) == "function" and typeof(writefile) == "function"
end

local function readConfigFile()
	if not canReadWriteFile() then return nil end
	local ok, raw = pcall(function()
		return readfile(CONFIG_FILE)
	end)
	if not ok or type(raw) ~= "string" or raw == "" then return nil end
	local okDec, tbl = pcall(function()
		return HttpService:JSONDecode(raw)
	end)
	if not okDec or type(tbl) ~= "table" then return nil end
	return tbl
end

local function writeConfigFile(tbl)
	if not canReadWriteFile() then return end
	if type(tbl) ~= "table" then return end
	local okEnc, raw = pcall(function()
		return HttpService:JSONEncode(tbl)
	end)
	if not okEnc or type(raw) ~= "string" then return end
	pcall(function()
		writefile(CONFIG_FILE, raw)
	end)
end

local antiSkidArmed = true
local antiSkidToken = Instance.new("Folder")
antiSkidToken.Name = "XentSemiTP_AntiSkid"
antiSkidToken.Parent = playerGui
local STAND_POSITION = Vector3.new(-336.364, -5.093, 98.874)
local STAND_SIZE = Vector3.new(2, 3, 2)
local TELEPORT_OFFSET = Vector3.new(-16, 0, -24)
local TELEPORT_POSITION = STAND_POSITION + TELEPORT_OFFSET
local TELEPORT_SIZE = Vector3.new(2, 3, 2)

local STEAL_SEARCH_RADIUS = 65
local STEAL_HOLD_EARLY_EQUIP = 0.1
local STEAL_TOOL_NAME = "Flying Carpet"

local DEFAULT_TELEPORT_KEY_NAME = "G"

local TELEPORT_STEP_DELAY = 0.15
local TELEPORT_PATH_POSITIONS = {
	Vector3.new(-352.4, -5.4, 114.08),
	Vector3.new(-348.96, -5.40, 62.89),
	Vector3.new(-350.73, -5.36, 18.39),
	Vector3.new(-330.58, -3.15, 18.85),
}
local config = _G.XentSemiTP_Config
if type(config) ~= "table" then
	config = {}
end

do
	local persisted = readConfigFile()
	if type(persisted) == "table" then
		for k, v in pairs(persisted) do
			if config[k] == nil then
				config[k] = v
			end
		end
	end
end

local function persistConfig()
	writeConfigFile(config)
end
config.teleportKeyName = config.teleportKeyName or DEFAULT_TELEPORT_KEY_NAME
if config.autoDesync == nil then
	config.autoDesync = false
end
if config.teleportSystemEnabled == nil then
	config.teleportSystemEnabled = true
end
if config.autoSpeed == nil then
	config.autoSpeed = false
end
if config.autoGrab == nil then
	config.autoGrab = true
end
_G.XentSemiTP_Config = config

local teleportSystemEnabled = config.teleportSystemEnabled
local teleportKeyCode = Enum.KeyCode[config.teleportKeyName] or Enum.KeyCode[DEFAULT_TELEPORT_KEY_NAME]

local running = true
local connections = {}
local runStealAndTeleport, teleportToStand, startDesync -- forward declarations so connections can call them safely

local function track(conn)
    table.insert(connections, conn)
    return conn
end

track(antiSkidToken.AncestryChanged:Connect(function(_, parent)
	if not antiSkidArmed then return end
	if parent ~= nil then return end
	running = false
	pcall(function()
		localPlayer:Kick("Tryna skid us or sum " .. DISCORD_LINK)
	end)
end))

local function getCharacter()
    local char = localPlayer.Character
    if not char or not char.Parent then
        char = localPlayer.CharacterAdded:Wait()
    end
    return char
end

local function findToolByName(name)
    local lowerName = string.lower(name)
    local backpack = localPlayer:FindFirstChildOfClass("Backpack")
    if backpack then
        local tool = backpack:FindFirstChild(name)
        if tool and tool:IsA("Tool") then
            return tool, backpack
        end
        for _, child in ipairs(backpack:GetChildren()) do
            if child:IsA("Tool") and string.find(string.lower(child.Name), lowerName, 1, true) then
                return child, backpack
            end
        end
    end

    local char = localPlayer.Character
    if char then
        local tool = char:FindFirstChild(name)
        if tool and tool:IsA("Tool") then
            return tool, char
        end
        for _, child in ipairs(char:GetChildren()) do
            if child:IsA("Tool") and string.find(string.lower(child.Name), lowerName, 1, true) then
                return child, char
            end
        end
    end

    return nil
end

local function equipToolByName(name)
    local tool, parent = findToolByName(name)
    if not tool then return nil end

    local char = getCharacter()
    local humanoid = char:FindFirstChildOfClass("Humanoid")
    if humanoid then
        humanoid:EquipTool(tool)
    else
        tool.Parent = char
    end

    return tool
end
local mainGui = Instance.new("ScreenGui")
mainGui.Name = "XentSemiTP_GUI"
mainGui.ResetOnSpawn = false
mainGui.IgnoreGuiInset = true
mainGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
mainGui.Parent = playerGui

local frame = Instance.new("Frame")
frame.Name = "MainFrame"
frame.Size = UDim2.fromOffset(230, 262)
frame.Position = UDim2.new(0.5, -115, 0.5, -80)
frame.BackgroundColor3 = Color3.fromRGB(10, 25, 35)
frame.Active = true
frame.Draggable = true
frame.Parent = mainGui

local corner = Instance.new("UICorner", frame)
corner.CornerRadius = UDim.new(0, 12)

local stroke = Instance.new("UIStroke", frame)
stroke.Color = Color3.fromRGB(0, 200, 255)
stroke.Thickness = 1.8
stroke.Transparency = 0.1

local header = Instance.new("Frame", frame)
header.Name = "Header"
header.Size = UDim2.new(1, 0, 0, 32)
header.BackgroundColor3 = Color3.fromRGB(8, 18, 26)
local headerCorner = Instance.new("UICorner", header)
headerCorner.CornerRadius = UDim.new(0, 12)

local title = Instance.new("TextLabel", header)
title.BackgroundTransparency = 1
title.Size = UDim2.new(1, -60, 0, 18)
title.Position = UDim2.fromOffset(10, 2)
title.Font = Enum.Font.GothamBold
title.TextSize = 16
title.TextXAlignment = Enum.TextXAlignment.Left
title.TextColor3 = Color3.fromRGB(0, 220, 255)
title.Text = "XENT SEMI TP"

local closeBtn = Instance.new("TextButton", header)
closeBtn.Name = "Close"
closeBtn.Size = UDim2.fromOffset(22, 22)
closeBtn.Position = UDim2.new(1, -26, 0.5, -11)
closeBtn.BackgroundColor3 = Color3.fromRGB(30, 50, 60)
closeBtn.Text = "X"
closeBtn.Font = Enum.Font.GothamBold
closeBtn.TextSize = 14
closeBtn.TextColor3 = Color3.fromRGB(0, 220, 255)
local closeCorner = Instance.new("UICorner", closeBtn)
closeCorner.CornerRadius = UDim.new(0, 8)

local collapseBtn = Instance.new("TextButton", header)
collapseBtn.Name = "Collapse"
collapseBtn.Size = UDim2.fromOffset(18, 18)
collapseBtn.Position = UDim2.new(1, -50, 0.5, -9)
collapseBtn.BackgroundColor3 = Color3.fromRGB(20, 40, 55)
collapseBtn.Text = "-"
collapseBtn.Font = Enum.Font.GothamBold
collapseBtn.TextSize = 12
collapseBtn.TextColor3 = Color3.fromRGB(0, 220, 255)
local collapseCorner = Instance.new("UICorner", collapseBtn)
collapseCorner.CornerRadius = UDim.new(0, 6)
local headerDiscordLabel = Instance.new("TextLabel", header)
headerDiscordLabel.BackgroundTransparency = 1
headerDiscordLabel.Size = UDim2.new(1, -60, 0, 12)
headerDiscordLabel.Position = UDim2.fromOffset(10, 20)
headerDiscordLabel.Font = Enum.Font.Gotham
headerDiscordLabel.TextSize = 10
headerDiscordLabel.TextColor3 = Color3.fromRGB(0, 200, 255)
headerDiscordLabel.TextXAlignment = Enum.TextXAlignment.Left
headerDiscordLabel.Text = DISCORD_LINK
local discordLabel = Instance.new("TextLabel", frame)
discordLabel.BackgroundTransparency = 1
discordLabel.Size = UDim2.new(1, -10, 0, 16)
discordLabel.Position = UDim2.new(0, 5, 1, -20)
discordLabel.Font = Enum.Font.GothamMedium
discordLabel.TextSize = 11
discordLabel.TextColor3 = Color3.fromRGB(0, 200, 255)
discordLabel.TextXAlignment = Enum.TextXAlignment.Center
discordLabel.Text = DISCORD_LINK

local teleportBtn = Instance.new("TextButton", frame)
teleportBtn.Name = "TeleportSystem"
teleportBtn.Size = UDim2.new(1, -20, 0, 34)
teleportBtn.Position = UDim2.fromOffset(10, 46)
teleportBtn.BackgroundColor3 = Color3.fromRGB(0, 185, 80)
teleportBtn.Text = "Teleport System: ON"
teleportBtn.Font = Enum.Font.GothamBold
teleportBtn.TextSize = 15
teleportBtn.TextColor3 = Color3.fromRGB(10, 20, 15)
local tpCorner = Instance.new("UICorner", teleportBtn)
tpCorner.CornerRadius = UDim.new(0, 8)

local desyncBtn = Instance.new("TextButton", frame)
desyncBtn.Name = "DesyncButton"
desyncBtn.Size = UDim2.new(1, -20, 0, 34)
desyncBtn.Position = UDim2.fromOffset(10, 90)
desyncBtn.BackgroundColor3 = Color3.fromRGB(0, 200, 255)
desyncBtn.Text = "Desync"
desyncBtn.Font = Enum.Font.GothamBold
desyncBtn.TextSize = 15
desyncBtn.TextColor3 = Color3.fromRGB(10, 20, 25)
local desCorner = Instance.new("UICorner", desyncBtn)
desCorner.CornerRadius = UDim.new(0, 8)
local tpBaseSize = teleportBtn.Size
local tpHoverSize = UDim2.new(tpBaseSize.X.Scale, tpBaseSize.X.Offset + 6, tpBaseSize.Y.Scale, tpBaseSize.Y.Offset + 4)

local function updateTeleportButtonVisual()
	if teleportSystemEnabled then
		teleportBtn.Text = "Teleport System: ON"
		teleportBtn.BackgroundColor3 = Color3.fromRGB(0, 185, 80)
	else
		teleportBtn.Text = "Teleport System: OFF"
		teleportBtn.BackgroundColor3 = Color3.fromRGB(170, 40, 40)
	end
end

teleportBtn.MouseEnter:Connect(function()
	local hoverColor
	if teleportSystemEnabled then
		hoverColor = Color3.fromRGB(0, 210, 95)
	else
		hoverColor = Color3.fromRGB(200, 60, 60)
	end
	TweenService:Create(teleportBtn, TweenInfo.new(0.12, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {
		Size = tpHoverSize,
		BackgroundColor3 = hoverColor,
	}):Play()
end)

teleportBtn.MouseLeave:Connect(function()
	TweenService:Create(teleportBtn, TweenInfo.new(0.12, Enum.EasingStyle.Sine, Enum.EasingDirection.Out), {
		Size = tpBaseSize,
		BackgroundColor3 = teleportSystemEnabled and Color3.fromRGB(0, 185, 80) or Color3.fromRGB(170, 40, 40),
	}):Play()
end)

teleportBtn.MouseButton1Click:Connect(function()
	teleportSystemEnabled = not teleportSystemEnabled
	config.teleportSystemEnabled = teleportSystemEnabled
	_G.XentSemiTP_Config = config
	persistConfig()
	updateTeleportButtonVisual()
end)

updateTeleportButtonVisual()
local teleportRow = Instance.new("Frame", frame)
teleportRow.BackgroundTransparency = 1
teleportRow.Size = UDim2.new(1, -20, 0, 22)
teleportRow.Position = UDim2.fromOffset(10, 134)

local singleTeleportBtn = Instance.new("TextButton", teleportRow)
singleTeleportBtn.Name = "TeleportOnce"
singleTeleportBtn.Size = UDim2.new(0.55, 0, 1, 0)
singleTeleportBtn.BackgroundColor3 = Color3.fromRGB(0, 160, 255)
singleTeleportBtn.Text = "Teleport"
singleTeleportBtn.Font = Enum.Font.GothamBold
singleTeleportBtn.TextSize = 13
singleTeleportBtn.TextColor3 = Color3.fromRGB(10, 20, 25)
local singleTpCorner = Instance.new("UICorner", singleTeleportBtn)
singleTpCorner.CornerRadius = UDim.new(0, 8)

local keyBox = Instance.new("TextBox", teleportRow)
keyBox.Name = "TeleportKeyBox"
keyBox.Size = UDim2.new(0.4, 0, 1, 0)
keyBox.Position = UDim2.new(0.6, 0, 0, 0)
keyBox.BackgroundColor3 = Color3.fromRGB(15, 35, 50)
keyBox.Font = Enum.Font.Gotham
keyBox.TextSize = 12
keyBox.Text = config.teleportKeyName
keyBox.TextColor3 = Color3.fromRGB(210, 230, 255)
local keyCorner = Instance.new("UICorner", keyBox)
keyCorner.CornerRadius = UDim.new(0, 8)
local autoRow = Instance.new("Frame", frame)
autoRow.BackgroundTransparency = 1
autoRow.Size = UDim2.new(1, -20, 0, 22)
autoRow.Position = UDim2.fromOffset(10, 162)

local autoLabel = Instance.new("TextLabel", autoRow)
autoLabel.BackgroundTransparency = 1
autoLabel.Size = UDim2.new(1, -70, 1, 0)
autoLabel.TextXAlignment = Enum.TextXAlignment.Left
autoLabel.Font = Enum.Font.Gotham
autoLabel.TextSize = 13
autoLabel.TextColor3 = Color3.fromRGB(200, 220, 240)
autoLabel.Text = "Auto Desync"

local autoToggle = Instance.new("TextButton", autoRow)
autoToggle.Name = "AutoDesyncToggle"
autoToggle.Size = UDim2.new(0, 60, 1, 0)
autoToggle.Position = UDim2.new(1, -60, 0, 0)
autoToggle.Font = Enum.Font.GothamBold
autoToggle.TextSize = 12

local autoCorner = Instance.new("UICorner", autoToggle)
autoCorner.CornerRadius = UDim.new(0, 10)

local function updateAutoToggleVisual()
	if config.autoDesync then
		autoToggle.Text = "ON"
		autoToggle.BackgroundColor3 = Color3.fromRGB(0, 185, 80)
		autoToggle.TextColor3 = Color3.fromRGB(10, 20, 15)
	else
		autoToggle.Text = "OFF"
		autoToggle.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
		autoToggle.TextColor3 = Color3.fromRGB(210, 220, 230)
	end
end

autoToggle.MouseButton1Click:Connect(function()
	local newVal = not config.autoDesync
	config.autoDesync = newVal
	_G.XentSemiTP_Config = config
	persistConfig()
	updateAutoToggleVisual()
	if newVal then
		startDesync()
	end
end)

updateAutoToggleVisual()
local autoSpeedEnabled = config.autoSpeed == true

local autoSpeedRow = Instance.new("Frame", frame)
autoSpeedRow.BackgroundTransparency = 1
autoSpeedRow.Size = UDim2.new(1, -20, 0, 22)
autoSpeedRow.Position = UDim2.fromOffset(10, 190)

local autoSpeedLabel = Instance.new("TextLabel", autoSpeedRow)
autoSpeedLabel.BackgroundTransparency = 1
autoSpeedLabel.Size = UDim2.new(1, -70, 1, 0)
autoSpeedLabel.TextXAlignment = Enum.TextXAlignment.Left
autoSpeedLabel.Font = Enum.Font.Gotham
autoSpeedLabel.TextSize = 13
autoSpeedLabel.TextColor3 = Color3.fromRGB(200, 220, 240)
autoSpeedLabel.Text = "Auto Speed"

local autoSpeedToggle = Instance.new("TextButton", autoSpeedRow)
autoSpeedToggle.Name = "AutoSpeedToggle"
autoSpeedToggle.Size = UDim2.new(0, 60, 1, 0)
autoSpeedToggle.Position = UDim2.new(1, -60, 0, 0)
autoSpeedToggle.Font = Enum.Font.GothamBold
autoSpeedToggle.TextSize = 12

local autoSpeedCorner = Instance.new("UICorner", autoSpeedToggle)
autoSpeedCorner.CornerRadius = UDim.new(0, 10)

local function updateAutoSpeedVisual()
	if autoSpeedEnabled then
		autoSpeedToggle.Text = "ON"
		autoSpeedToggle.BackgroundColor3 = Color3.fromRGB(0, 185, 80)
		autoSpeedToggle.TextColor3 = Color3.fromRGB(10, 20, 15)
	else
		autoSpeedToggle.Text = "OFF"
		autoSpeedToggle.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
		autoSpeedToggle.TextColor3 = Color3.fromRGB(210, 220, 230)
	end
end

autoSpeedToggle.MouseButton1Click:Connect(function()
	autoSpeedEnabled = not autoSpeedEnabled
	config.autoSpeed = autoSpeedEnabled
	_G.XentSemiTP_Config = config
	persistConfig()
	updateAutoSpeedVisual()
end)

updateAutoSpeedVisual()
local autoGrabEnabled = config.autoGrab == true

local autoGrabRow = Instance.new("Frame", frame)
autoGrabRow.BackgroundTransparency = 1
autoGrabRow.Size = UDim2.new(1, -20, 0, 22)
autoGrabRow.Position = UDim2.fromOffset(10, 218)

local autoGrabLabel = Instance.new("TextLabel", autoGrabRow)
autoGrabLabel.BackgroundTransparency = 1
autoGrabLabel.Size = UDim2.new(1, -70, 1, 0)
autoGrabLabel.TextXAlignment = Enum.TextXAlignment.Left
autoGrabLabel.Font = Enum.Font.Gotham
autoGrabLabel.TextSize = 13
autoGrabLabel.TextColor3 = Color3.fromRGB(200, 220, 240)
autoGrabLabel.Text = "Auto Grab"

local autoGrabToggle = Instance.new("TextButton", autoGrabRow)
autoGrabToggle.Name = "AutoGrabToggle"
autoGrabToggle.Size = UDim2.new(0, 60, 1, 0)
autoGrabToggle.Position = UDim2.new(1, -60, 0, 0)
autoGrabToggle.Font = Enum.Font.GothamBold
autoGrabToggle.TextSize = 12

local autoGrabCorner = Instance.new("UICorner", autoGrabToggle)
autoGrabCorner.CornerRadius = UDim.new(0, 10)

local function updateAutoGrabVisual()
	if autoGrabEnabled then
		autoGrabToggle.Text = "ON"
		autoGrabToggle.BackgroundColor3 = Color3.fromRGB(0, 185, 80)
		autoGrabToggle.TextColor3 = Color3.fromRGB(10, 20, 15)
	else
		autoGrabToggle.Text = "OFF"
		autoGrabToggle.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
		autoGrabToggle.TextColor3 = Color3.fromRGB(210, 220, 230)
	end
end

autoGrabToggle.MouseButton1Click:Connect(function()
	autoGrabEnabled = not autoGrabEnabled
	config.autoGrab = autoGrabEnabled
	_G.XentSemiTP_Config = config
	persistConfig()
	updateAutoGrabVisual()
end)

updateAutoGrabVisual()
local collapsed = false

local function setCollapsed(state)
	collapsed = state
	local visible = not state
	teleportBtn.Visible = visible
	desyncBtn.Visible = visible
	teleportRow.Visible = visible
	autoRow.Visible = visible
	autoSpeedRow.Visible = visible
	autoGrabRow.Visible = visible
	discordLabel.Visible = visible
	headerDiscordLabel.Visible = not visible
	frame.Size = visible and UDim2.fromOffset(230, 262) or UDim2.fromOffset(230, 48)
	collapseBtn.Text = visible and "-" or "+"
end

collapseBtn.MouseButton1Click:Connect(function()
	setCollapsed(not collapsed)
end)

setCollapsed(false)
local function updateTeleportKeyFromName(name)
	local upper = string.upper(name)
	local keyEnum = Enum.KeyCode[upper]
	if keyEnum then
		teleportKeyCode = keyEnum
		config.teleportKeyName = upper
		_G.XentSemiTP_Config = config
		persistConfig()
		keyBox.Text = upper
	else
		keyBox.Text = config.teleportKeyName
	end
end

keyBox.FocusLost:Connect(function(enterPressed)
	local txt = keyBox.Text or ""
	if txt == "" then return end
	local token = txt:match("%w+") or ""
	local firstChar = token:sub(1, 1)
	if firstChar == "" then return end
	updateTeleportKeyFromName(firstChar)
end)

singleTeleportBtn.MouseButton1Click:Connect(function()
	if not running or not teleportSystemEnabled then return end
	if teleportToStand then
		teleportToStand()
	end
end)

track(UserInputService.InputBegan:Connect(function(input, gpe)
	if gpe or not running or not teleportSystemEnabled then return end
	if input.UserInputType == Enum.UserInputType.Keyboard and input.KeyCode == teleportKeyCode then
		if teleportToStand then
			teleportToStand()
		end
	end
end))
local standPart
local teleportPart
local stealInProgress = false
local isLocked = false
local prevWalkSpeed, prevJumpPower, prevAutoRotate
local hasFacedOnce = false
local autoSpeedActive = false
local autoSpeedEndTime = 0

local lastTeleportToTeleportPart = 0
local TELEPORT_PART_COOLDOWN = 1.5

local function faceForward()
	local char = getCharacter()
	local root = char:FindFirstChild("HumanoidRootPart")
	if not root then return end
	local target = teleportPart and teleportPart.Position or (root.Position + root.CFrame.LookVector * 10)
	target = Vector3.new(target.X, root.Position.Y, target.Z)
	root.CFrame = CFrame.new(root.Position, target)
end

local function lockCharacter()
    if isLocked then return end
    local char = getCharacter()
    local hum = char:FindFirstChildOfClass("Humanoid")
    local root = char:FindFirstChild("HumanoidRootPart")
    if not hum or not root then return end
    isLocked = true
    prevWalkSpeed = hum.WalkSpeed
    prevJumpPower = hum.JumpPower
    prevAutoRotate = hum.AutoRotate
    hum.WalkSpeed = 0
    hum.JumpPower = 0
    hum.AutoRotate = false
    root.Anchored = true
end

local function unlockCharacter()
    if not isLocked then return end
    isLocked = false
    local char = localPlayer.Character
    if not char then return end
    local hum = char:FindFirstChildOfClass("Humanoid")
    local root = char:FindFirstChild("HumanoidRootPart")
    if hum then
        hum.WalkSpeed = prevWalkSpeed or 16
        hum.JumpPower = prevJumpPower or 50
        hum.AutoRotate = (prevAutoRotate ~= nil) and prevAutoRotate or true
    end
    if root then
        root.Anchored = false
    end
end

local function destroyParts()
    if standPart then standPart:Destroy() end
    if teleportPart then teleportPart:Destroy() end
    standPart = nil
    teleportPart = nil
end

local function createStandAndTeleport()
	destroyParts()

    standPart = Instance.new("Part")
    standPart.Name = "XENT_SemiTP_StealHere"
    standPart.Size = STAND_SIZE
    standPart.Anchored = true
    standPart.CanCollide = false
    standPart.Transparency = 1
    standPart.Position = STAND_POSITION
    standPart.Color = Color3.fromRGB(0, 0, 255)
    standPart.Parent = Workspace

    local box1 = Instance.new("BoxHandleAdornment")
    box1.Adornee = standPart
    box1.Size = STAND_SIZE
    box1.AlwaysOnTop = true
    box1.ZIndex = 10
    box1.Color3 = Color3.fromRGB(0, 0, 255)
    box1.Transparency = 0.3
    box1.Parent = standPart

    local billboard1 = Instance.new("BillboardGui")
    billboard1.Size = UDim2.new(0, 120, 0, 20)
    billboard1.StudsOffset = Vector3.new(0, STAND_SIZE.Y / 2 + 0.8, 0)
    billboard1.AlwaysOnTop = true
    billboard1.Parent = standPart

    local label1 = Instance.new("TextLabel")
    label1.Size = UDim2.fromScale(1, 1)
    label1.BackgroundTransparency = 1
    label1.Text = "Steal here"
    label1.TextColor3 = Color3.fromRGB(255, 255, 255)
    label1.TextStrokeTransparency = 0
    label1.TextStrokeColor3 = Color3.new(0, 0, 0)
    label1.TextScaled = false
    label1.TextSize = 18
    label1.Font = Enum.Font.GothamBold
    label1.Parent = billboard1

    teleportPart = Instance.new("Part")
    teleportPart.Name = "XENT_SemiTP_TeleportHere"
    teleportPart.Size = TELEPORT_SIZE
    teleportPart.Anchored = true
    teleportPart.CanCollide = false
    teleportPart.Transparency = 1
    teleportPart.Position = STAND_POSITION + TELEPORT_OFFSET
    teleportPart.Color = Color3.fromRGB(0, 0, 255)
    teleportPart.Parent = Workspace

    local box2 = Instance.new("BoxHandleAdornment")
    box2.Adornee = teleportPart
    box2.Size = TELEPORT_SIZE
    box2.AlwaysOnTop = true
    box2.ZIndex = 10
    box2.Color3 = Color3.fromRGB(0, 0, 255)
    box2.Transparency = 0.3
    box2.Parent = teleportPart

    local billboard2 = Instance.new("BillboardGui")
    billboard2.Size = UDim2.new(0, 130, 0, 20)
    billboard2.StudsOffset = Vector3.new(0, TELEPORT_SIZE.Y / 2 + 0.8, 0)
    billboard2.AlwaysOnTop = true
    billboard2.Parent = teleportPart

    local label2 = Instance.new("TextLabel")
    label2.Size = UDim2.fromScale(1, 1)
    label2.BackgroundTransparency = 1
    label2.Text = "Teleport here"
    label2.TextColor3 = Color3.fromRGB(255, 255, 255)
    label2.TextStrokeTransparency = 0
    label2.TextStrokeColor3 = Color3.new(0, 0, 0)
    label2.TextScaled = false
    label2.TextSize = 18
    label2.Font = Enum.Font.GothamBold
    label2.Parent = billboard2

    track(standPart.Touched:Connect(function(hit)
        if not running or not teleportSystemEnabled then return end
        local model = hit:FindFirstAncestorOfClass("Model")
        if not model then return end
        if Players:GetPlayerFromCharacter(model) ~= localPlayer then return end
        if not hasFacedOnce then
            hasFacedOnce = true
            faceForward()
        end
        -- actual Steal hold is handled by the global auto-grab listener (PromptShown)
    end))
end

local function safeTeleport(root, targetCFrame)
	if not root then return end
	local char = root.Parent
	pcall(function()
		if char and char:IsA("Model") and char:FindFirstChildOfClass("Humanoid") and char.PivotTo then
			char:PivotTo(targetCFrame)
		else
			root.CFrame = targetCFrame
		end
		if root.AssemblyLinearVelocity then
			root.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
			root.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
		else
			root.Velocity = Vector3.new(0, 0, 0)
			root.RotVelocity = Vector3.new(0, 0, 0)
		end
	end)
end

local function teleportToTeleportPart()
	local now = tick()
	if now - lastTeleportToTeleportPart < TELEPORT_PART_COOLDOWN then return end
	local char = getCharacter()
	local root = char:FindFirstChild("HumanoidRootPart")
	if not root or not teleportPart then return end
	safeTeleport(root, CFrame.new(teleportPart.Position + Vector3.new(0, 4, 0)))
	lastTeleportToTeleportPart = now
end

local function teleportToStealSpot()
	local char = getCharacter()
	local root = char:FindFirstChild("HumanoidRootPart")
	if not root then return end
	local finalStandPos = (standPart and standPart.Position) or STAND_POSITION
	local finalLookPos = (teleportPart and teleportPart.Position) or (finalStandPos + Vector3.new(0, 0, -10))
	finalLookPos = Vector3.new(finalLookPos.X, finalStandPos.Y, finalLookPos.Z)
	safeTeleport(root, CFrame.new(finalStandPos + Vector3.new(0, 2, 0), finalLookPos))
end

teleportToStand = function()
	if not teleportSystemEnabled then return end
	task.spawn(function()
		local char = getCharacter()
		local root = char:FindFirstChild("HumanoidRootPart")
		local hum = char:FindFirstChildOfClass("Humanoid")
		if not root or not hum then return end

		pcall(function()
			hum:UnequipTools()
		end)
		equipToolByName(STEAL_TOOL_NAME)
		task.wait(TELEPORT_STEP_DELAY)

		if not running or not teleportSystemEnabled then return end
		local finalStandPos = (standPart and standPart.Position) or STAND_POSITION
		local finalLookPos = (teleportPart and teleportPart.Position) or (finalStandPos + Vector3.new(0, 0, -10))
		finalLookPos = Vector3.new(finalLookPos.X, finalStandPos.Y, finalLookPos.Z)
		pcall(function()
			root.CFrame = CFrame.new(finalStandPos + Vector3.new(0, 2, 0), finalLookPos)
			if root.AssemblyLinearVelocity then
				root.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
				root.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
			else
				root.Velocity = Vector3.new(0, 0, 0)
				root.RotVelocity = Vector3.new(0, 0, 0)
			end
		end)
	end)
end

local AUTO_SPEED_VALUE = 28
local AUTO_SPEED_DURATION = 15

local function startAutoSpeedBoost()
	if not autoSpeedEnabled then return end
	autoSpeedActive = true
	autoSpeedEndTime = tick() + AUTO_SPEED_DURATION
	local thisToken = autoSpeedEndTime
	task.delay(AUTO_SPEED_DURATION, function()
		if autoSpeedEndTime ~= thisToken then return end
		autoSpeedActive = false
	end)
end

RunService.Heartbeat:Connect(function()
	if not autoSpeedActive then return end
	if tick() > autoSpeedEndTime then
		autoSpeedActive = false
		return
	end
	local char = localPlayer.Character
	if not char then return end
	local hum = char:FindFirstChildOfClass("Humanoid")
	local root = char:FindFirstChild("HumanoidRootPart")
	if not hum or not root then return end

	local move = hum.MoveDirection
	local vel = root.Velocity
	if move.Magnitude > 0 then
		local flat = Vector3.new(move.X, 0, move.Z).Unit
		local target = flat * AUTO_SPEED_VALUE
		root.Velocity = Vector3.new(target.X, vel.Y, target.Z)
	else
		root.Velocity = Vector3.new(0, vel.Y, 0)
	end
end)

local function findEscapeSurfacePosition()
	local targetName = "ESCAPE TSUNAMI LTM"
	for _, inst in ipairs(Workspace:GetDescendants()) do
		if inst:IsA("SurfaceGui") or inst:IsA("BillboardGui") then
			local match = false
			if inst.Name == targetName then
				match = true
			else
				for _, child in ipairs(inst:GetDescendants()) do
					if (child:IsA("TextLabel") or child:IsA("TextButton")) and type(child.Text) == "string" then
						if child.Text:find(targetName, 1, true) then
							match = true
							break
						end
					end
				end
			end
			if match then
				local part = inst.Adornee
				if not part or not part:IsA("BasePart") then
					part = inst.Parent
				end
				if part and part:IsA("BasePart") then
					return part.Position + Vector3.new(0, 6, 0)
				end
			end
		end
	end
	return nil
end

local function isStealPrompt(prompt)
    local s = ""
    if prompt.ActionText then s ..= " " .. prompt.ActionText end
    if prompt.ObjectText then s ..= " " .. prompt.ObjectText end
    if prompt.Name then s ..= " " .. prompt.Name end
    s = string.lower(s)
    return s:find("steal", 1, true) ~= nil
end

local function findNearestStealPrompt(maxDist)
    local char = localPlayer.Character
    if not char then return nil end
    local root = char:FindFirstChild("HumanoidRootPart")
    if not root then return nil end
    local nearest
    local best = maxDist or STEAL_SEARCH_RADIUS
    for _, inst in ipairs(Workspace:GetDescendants()) do
        if inst:IsA("ProximityPrompt") and inst.Enabled then
            if isStealPrompt(inst) then
                local parentPart = inst.Parent
                if parentPart and parentPart:IsA("BasePart") then
                    local d = (root.Position - parentPart.Position).Magnitude
                    if d <= best then
                        best = d
                        nearest = inst
                    end
                end
            end
        end
    end
    return nearest
end

local function findNearestPromptAny(maxDist)
	local char = localPlayer.Character
	if not char then return nil end
	local root = char:FindFirstChild("HumanoidRootPart")
	if not root then return nil end
	local nearest
	local best = maxDist or STEAL_SEARCH_RADIUS
	for _, inst in ipairs(Workspace:GetDescendants()) do
		if inst:IsA("ProximityPrompt") and inst.Enabled then
			local parentPart = inst.Parent
			if parentPart and parentPart:IsA("BasePart") then
				local d = (root.Position - parentPart.Position).Magnitude
				if d <= best then
					best = d
					nearest = inst
				end
			end
		end
	end
	return nearest
end

runStealAndTeleport = function()
	if not running or not teleportSystemEnabled then return end
end

track(ProximityPromptService.PromptButtonHoldEnded:Connect(function(prompt, player)
	if not running or not teleportSystemEnabled then return end
	if player ~= localPlayer then return end
	if not isStealPrompt(prompt) then return end
	if stealInProgress then return end
	equipToolByName(STEAL_TOOL_NAME)
	teleportToTeleportPart()
end))

local function autoGrabProcessPrompt(prompt)
	if not running or not teleportSystemEnabled then return end
	if not prompt or not prompt.Parent or not prompt.Enabled then return end
	if not isStealPrompt(prompt) then return end
	local holdTime = prompt.HoldDuration or 0
	task.spawn(function()
		pcall(function()
			if prompt.InputHoldBegin then
				prompt:InputHoldBegin()
			else
				ProximityPromptService:InputHoldBegin(prompt)
			end
		end)
		local delayTime = (holdTime > 0) and (holdTime + 0.05) or 0.1
		task.delay(delayTime, function()
			if not running or not teleportSystemEnabled then return end
			if not prompt or not prompt.Parent or not prompt.Enabled then return end
			pcall(function()
				if prompt.InputHoldEnd then
					prompt:InputHoldEnd()
				else
					ProximityPromptService:InputHoldEnd(prompt)
				end
			end)
		end)
	end)
end

track(ProximityPromptService.PromptShown:Connect(function(prompt)
	if not autoGrabEnabled then return end
	autoGrabProcessPrompt(prompt)
end))

track(ProximityPromptService.PromptTriggered:Connect(function(prompt, plr)
	if not autoSpeedEnabled then return end
	if plr ~= localPlayer then return end
	if not isStealPrompt(prompt) then return end
	startAutoSpeedBoost()
end))

local FFlags = {
    GameNetPVHeaderRotationalVelocityZeroCutoffExponent = -5000,
    LargeReplicatorWrite5 = true,
    LargeReplicatorEnabled9 = true,
    AngularVelociryLimit = 360,
    TimestepArbiterVelocityCriteriaThresholdTwoDt = 2147483646,
    S2PhysicsSenderRate = 15000,
    DisableDPIScale = true,
    MaxDataPacketPerSend = 2147483647,
    PhysicsSenderMaxBandwidthBps = 20000,
    TimestepArbiterHumanoidLinearVelThreshold = 21,
    MaxMissedWorldStepsRemembered = -2147483648,
    PlayerHumanoidPropertyUpdateRestrict = true,
    SimDefaultHumanoidTimestepMultiplier = 0,
    StreamJobNOUVolumeLengthCap = 2147483647,
    DebugSendDistInSteps = -2147483648,
    GameNetDontSendRedundantNumTimes = 1,
    CheckPVLinearVelocityIntegrateVsDeltaPositionThresholdPercent = 1,
    CheckPVDifferencesForInterpolationMinVelThresholdStudsPerSecHundredth = 1,
    LargeReplicatorSerializeRead3 = true,
    ReplicationFocusNouExtentsSizeCutoffForPauseStuds = 2147483647,
    CheckPVCachedVelThresholdPercent = 10,
    CheckPVDifferencesForInterpolationMinRotVelThresholdRadsPerSecHundredth = 1,
    GameNetDontSendRedundantDeltaPositionMillionth = 1,
    InterpolationFrameVelocityThresholdMillionth = 5,
    StreamJobNOUVolumeCap = 2147483647,
    InterpolationFrameRotVelocityThresholdMillionth = 5,
    CheckPVCachedRotVelThresholdPercent = 10,
    WorldStepMax = 30,
    InterpolationFramePositionThresholdMillionth = 5,
    TimestepArbiterHumanoidTurningVelThreshold = 1,
    SimOwnedNOUCountThresholdMillionth = 2147483647,
    GameNetPVHeaderLinearVelocityZeroCutoffExponent = -5000,
    NextGenReplicatorEnabledWrite4 = true,
    TimestepArbiterOmegaThou = 1073741823,
    MaxAcceptableUpdateDelay = 1,
    LargeReplicatorSerializeWrite4 = true,
}

local ESPFolder, ServerESP
local serverPosition
local positionConn
local desyncEnabled = false

local function ApplyFFlags()
    for name, value in pairs(FFlags) do
        pcall(function()
            setfflag(tostring(name), tostring(value))
        end)
    end
end

local function RespawnPlayer()
    local char = localPlayer.Character
    if not char then return end

    local hum = char:FindFirstChildWhichIsA("Humanoid")
    if hum then
        hum:ChangeState(Enum.HumanoidStateType.Dead)
    end

    char:ClearAllChildren()
    local temp = Instance.new("Model", Workspace)
    localPlayer.Character = temp
    task.wait()
    localPlayer.Character = char
    temp:Destroy()
end

local function ClearESP()
    if positionConn then
        positionConn:Disconnect()
        positionConn = nil
    end
    if ESPFolder then
        ESPFolder:Destroy()
        ESPFolder = nil
    end
    ServerESP = nil
end

local function CreateESPPart(name, color)
    local part = Instance.new("Part")
    part.Size = Vector3.new(2, 5, 2)
    part.Anchored = true
    part.CanCollide = false
    part.Material = Enum.Material.Neon
    part.Color = color
    part.Transparency = 0.25
    part.Parent = ESPFolder

    local highlight = Instance.new("Highlight", part)
    highlight.FillColor = color
    highlight.OutlineColor = color
    highlight.FillTransparency = 0.4

    local bb = Instance.new("BillboardGui", part)
    bb.Size = UDim2.new(0, 130, 0, 30)
    bb.AlwaysOnTop = true
    bb.Adornee = part

    local txt = Instance.new("TextLabel", bb)
    txt.Size = UDim2.new(1, 0, 1, 0)
    txt.BackgroundTransparency = 1
    txt.Text = name
    txt.TextScaled = true
    txt.Font = Enum.Font.GothamBold
    txt.TextColor3 = color

    return part
end

local function TrackServer(hrp)
    serverPosition = hrp.Position
    positionConn = hrp:GetPropertyChangedSignal("Position"):Connect(function()
        task.wait(0.15)
        if hrp then
            serverPosition = hrp.Position
            if ServerESP then
                ServerESP.CFrame = CFrame.new(serverPosition)
            end
        end
    end)
end

local function SetServerESP()
	ClearESP()
end

track(localPlayer.CharacterAdded:Connect(function()
    if not running then return end
    task.wait(0.5)
    createStandAndTeleport()
end))

if localPlayer.Character then
    createStandAndTeleport()
end
startDesync = function()
	if desyncEnabled then return end
	desyncEnabled = true
	desyncBtn.Text = "Desync Enabled"
	desyncBtn.AutoButtonColor = false
	desyncBtn.BackgroundColor3 = Color3.fromRGB(0, 180, 255)

	ApplyFFlags()
	RespawnPlayer()
	ClearESP()
end

track(desyncBtn.MouseButton1Click:Connect(function()
    startDesync()
end))
if config.autoDesync then
    task.defer(function()
        if not running then return end
        task.wait(0.5)
        startDesync()
    end)
end
local function shouldRewriteText(text)
    if type(text) ~= "string" or text == "" then return false end
    local lower = string.lower(text)
    if lower:find("empty base", 1, true) then return true end
    for _, plr in ipairs(Players:GetPlayers()) do
        local uname = string.lower(plr.Name)
        local dname = string.lower(plr.DisplayName or plr.Name)
        if lower:find(uname, 1, true) ~= nil or lower:find(dname, 1, true) ~= nil then
            return true
        end
    end
    return false
end

local originalSurfaceTexts = {}

local function styleDiscordText(label)
    if not originalSurfaceTexts[label] then
        originalSurfaceTexts[label] = label.Text
    end
    label.Text = DISCORD_LINK
    label.TextColor3 = Color3.fromRGB(0, 170, 255)
    label.TextStrokeTransparency = 0
    label.TextStrokeColor3 = Color3.new(0, 0, 0)
end

local function watchSurfaceTextObject(obj)
    if not (obj:IsA("TextLabel") or obj:IsA("TextButton")) then return end
    local sg = obj:FindFirstAncestorWhichIsA("SurfaceGui")
    if not sg then return end

    local function check()
        if shouldRewriteText(obj.Text) then
            styleDiscordText(obj)
        end
    end

    check()
    track(obj:GetPropertyChangedSignal("Text"):Connect(check))
end

for _, inst in ipairs(Workspace:GetDescendants()) do
    watchSurfaceTextObject(inst)
end

track(Workspace.DescendantAdded:Connect(function(inst)
    watchSurfaceTextObject(inst)
end))
local function cleanup()
	if not running then return end
	running = false
	antiSkidArmed = false
	pcall(function()
		if antiSkidToken and antiSkidToken.Parent then
			antiSkidToken:Destroy()
		end
	end)

	destroyParts()
	ClearESP()

	for label, original in pairs(originalSurfaceTexts) do
		pcall(function()
			if label and label.Parent then
				label.Text = original
			end
		end)
	end
	originalSurfaceTexts = {}

    for _, conn in ipairs(connections) do
        if conn and conn.Connected then
            conn:Disconnect()
        end
    end

    connections = {}

    	if mainGui and mainGui.Parent then
		mainGui:Destroy()
	end
end

_G.XentSemiTP_Cleanup = cleanup

closeBtn.MouseButton1Click:Connect(function()
    cleanup()
end)
